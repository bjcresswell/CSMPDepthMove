---
title: "Osprey predators - depth and temperature data import and wrangling"
author: "Ben Cresswell"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
 html_document:
    code_folding: show
    collapse: no
    df_print: paged
    fig_caption: yes
    fig_height: 4
    fig_width: 4
    highlight: textmate
    theme: spacelab
    toc: yes
    toc_float: yes
editor_options: 
  chunk_output_type: inline
---

This Rmd takes detection data from a/many Vue database(s), previously exported to csv format, combines this with tag and receiver metadata and wrangles together into one main dataframe - alldata

# PRELIMINARIES #

# Set up Rmd
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list=ls())
getwd()
```

# Load required packages
```{r packages, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
library(writexl)
library(readxl)
library(lubridate)
library(magrittr)
library(tidyverse)
```


# BACKGROUND #

Have deployment data at Osprey for 4 separate "periods":

(Dep1. Feb 2021 - Oct 2021: 7 x receivers - no T/P tags deployed so will discard this)
Dep2. Oct 2021 - Feb 2022: 7 x receivers (CSMP)
Dep3. Oct 2021 - Oct 2022: 7 x receivers (BJC)
Dep4. Feb 2022 - Feb 2023: 7 x receivers (CSMP)

Plus:

Dep4a. Feb2022 - Feb2023


# INITIAL WRANGLING #

Offloading detection data from receivers to Vue results in a .Vdb file in Vue which can then be exported as a .csv file 
Each deployment period is thus one chunk of data which needs to be joined with other deployments if you want to get a long term dataset
However each detection file typically only contains receiver serial numbers - details of what receiver was located at what site are contained in a separate csv file
Therefore the first thing to do is load up each deployment file along with its corresponding receiver metadata individually and combine together (Step 1)
Also need to combine with tag metadata (Step 2 below) which contains data on species, size, where/when tagged/releaased etc 
Can do this after combining deployments together as the tag metadata is the same for all deployments
Lastly, if you want to utilise the Animal Tracking Toolbox component of the vTrack package you need to wrangle the alldata file AND the metadata into the correct format (see separate Rmd)



# STEP 1: Loading base detection data and combining with receiver metadata


## Deployment 2 (Oct 2021 - Feb 2022 -> CSMP and BJC)

## Load detection database 2
```{r load-dep2, message=FALSE, warning=FALSE}
data_dep2 <- read_csv('../data/CSMPdb_uncal_202203.csv') %>% 
  tibble() %>% # Make into tibble format
  mutate(detection_timestamp = lubridate::as_datetime(DTG), .keep='unused', .before='Receiver')  %>%  # Sort out date-time column early
  dplyr::select(c(1,2,3,6,7)) %>% # Get rid of unused columns
  mutate_if(is.character, as.factor) %>% # Sort out variables
  mutate(receiver_name = Receiver, # Change some column names for merging below
         transmitter_id = Transmitter,
         .keep = 'unused')
```

# Do max and min dates make sense
```{r}
data_dep2 %$% 
  summary(as_datetime(detection_timestamp))
```

## List of receivers for deployment 2
```{r}
# Load list of receivers
vr2ws_dep2 <- read_excel('../data/receiver_list_dep2.xlsx', trim_ws = TRUE) %>%
  tibble() %>% # Make into tibble format
  mutate_if(is.character, as.factor) # Sort out variables
```

## Combine deployment 2
```{r}
osprey_dep2 <- data_dep2 %>%  
  merge(vr2ws_dep2, by='receiver_name') %>% 
  filter(installation_name == "Osprey")
```

# Checks deployment 2

```{r}
glimpse(osprey_dep2)
```

# Do max and min dates make sense?
```{r}
osprey_dep2 %$% 
  summary(detection_timestamp)
```

## Deployment 3 (Oct 2021 - Oct 2022 -> BJC only)

## Load detection database 3
```{r load-dep1}
data_dep3 <- read_csv('../data/CSMPdb_uncal_202210.csv') %>% 
  tibble() %>% # Make into tibble format
  mutate(detection_timestamp = as_datetime(DTG), .keep = 'unused', .before = 'Receiver') %>%  # Sort out date-time column early
  dplyr::select(c(1,2,3,6,7)) %>% # Get rid of unrequired columns
  mutate_if(is.character, as.factor) %>% # Sort out variables
  mutate(receiver_name = Receiver, # Change some column names for merging below
         transmitter_id = Transmitter,
         .keep = 'unused')
```

## List of receivers for deployment 3
```{r}
# Load list of receivers
vr2ws_dep3 <- read_excel('../data/receiver_list_dep3.xlsx', trim_ws = TRUE) %>%
  tibble() %>% # Make into tibble format
  mutate_if(is.character, as.factor) # Sort out variables
```

## Combine deployment 3
```{r}
osprey_dep3 <- data_dep3 %>%  
  merge(vr2ws_dep3, by='receiver_name') %>% 
  filter(installation_name == "Osprey")
```

# Check that max and min dates make sense
```{r}
osprey_dep3 %$% 
  summary(detection_timestamp)
```


## Deployment 4 (Feb 2022 - Feb 2023 -> CSMP only)

## Load detection database 4
```{r load-dep1}
data_dep4 <- read_csv('../data/CSMPdb_uncal_202303.csv') %>% 
  tibble() %>% # Make into tibble format
  mutate(detection_timestamp = as_datetime(DTG), .keep = 'unused', .before = 'Receiver') %>%  # Sort out date-time column early
  dplyr::select(c(1,2,3,6,7)) %>% # Get rid of unrequired columns
  mutate_if(is.character, as.factor) %>% # Sort out variables
  mutate(receiver_name = Receiver, # Change some column names for merging below
         transmitter_id = Transmitter,
         .keep = 'unused')
```

## Add in data-recovery files from Vemco
```{r load-dep1}
data_dep4a <- read_csv('../data/CSMPdb_data-recovery-2023-04.csv') %>% 
  tibble() %>% # Make into tibble format
  mutate(detection_timestamp = as_datetime(`Date and Time (UTC)`), .keep = 'unused', .before = 'Receiver') %>%  # Sort out date-time column early
  dplyr::select(c(1,2,3,6,7)) %>% # Get rid of unrequired columns
  mutate_if(is.character, as.factor) %>% # Sort out variables
  mutate(receiver_name = Receiver, # Change some column names for merging below
         transmitter_id = Transmitter,
         .keep = 'unused')
```
## Some checks on the "missing" data

## See when each one at Osprey crapped out
```{r}

data_dep4 %>% 
  group_by(receiver_name) %>% 
  summarise(max_date = max(detection_timestamp))

data_dep4a %>% 
  group_by(receiver_name) %>% 
  summarise(max_date = max(detection_timestamp))
```


## Combine two files for one consolidated deployment 4 file.
```{r}
data_dep4 <- data_dep4 %>% 
  bind_rows(data_dep4a)
rm(data_dep4a)
```



## List of receivers for deployment 4 (covers both the main file and the recovered data)
```{r}
# Load list of receivers
vr2ws_dep4 <- read_excel('../data/receiver_list_dep4.xlsx', trim_ws = TRUE) %>%
  tibble() %>% # Make into tibble format
  mutate_if(is.character, as.factor) # Sort out variables
```

## Combine deployment 4
```{r}
osprey_dep4 <- data_dep4 %>%  
  merge(vr2ws_dep4, by='receiver_name') %>% 
  filter(installation_name == "Osprey")
```

# Check that max and min dates make sense
```{r}
osprey_dep4 %$% 
  summary(detection_timestamp)
```
## Check when each crapped out at Osprey
```{r}
osprey_dep4 %>% 
  group_by(station_name_long) %>% 
  summarise(first_detection = min(detection_timestamp),
            last_detection = max(detection_timestamp)) %>% 
  mutate(deploy_duration = round(last_detection - first_detection, 0))
```



## Combine all 3 deployments together
At the same time we'll remove all non-T/P tag detections
```{r}
osp_sens_data <- rbind(osprey_dep2, osprey_dep3, osprey_dep4) %>% 
  filter(!is.na(`Sensor Value`)) %>% 
  droplevels()
summary(osp_sens_data$station_name) 
```
Now we have a whole data file, we can combine with information about tagged animal details (for animals that we have info for)


```{r}
osp_sens_data %>% 
  group_by(station_name_long) %>% 
  summarise(first_detection = min(detection_timestamp),
            last_detection = max(detection_timestamp)) %>% 
  mutate(deploy_duration = round(last_detection - first_detection, 0))

```




# STEP 2:  Animal/tag information

Need to add in information about animals (not just transmitter_id etc)

## For this information we need to load our project tag list
```{r load-proj-tags, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
source("../code/project_tag_list.R")
```

Have got 137 tagged animals in the Coral Sea. 

## Can filter from this list to see how many animals had sensor tags (all of which will be at Osprey)
```{r}
project_tags_all %>% 
  droplevels() %>% 
  #filter(Type != "pinger") %$% 
  filter(Type == "temp")  %$% 
  summary(Scientific_name)

```

We have 10 teleosts and 15 sharks - 25 total. Each has a temp and press transmitter_id so we should have 50 show up in our detections:
```{r}
osp_sens_data %>% 
  distinct(transmitter_id) %>% 
  merge(project_tags_all) %>% 
  droplevels() %$%
  summary(Location)
```

Only have 46, which means we are missing two animals. Will figure out which ones later.


## Combine animal info into main df
```{r}
osp_sens_data <- osp_sens_data %>% 
  merge(project_tags_all, by='transmitter_id', all.x = TRUE) %>% 
  droplevels() %>% 
  filter(!is.na(Org_type)) # If we don't know this then it's not an animal that we have tagged (could filter on other variables)
```


## Save

```{r}



```







## Assign just one transmitter id to each sensor tag
```{r}
alldata1 %>% 
  dplyr:: select(transmitter_id, Serial, Org_type, Type) %>% 
  distinct()
```
Sharks: a lower-even ID for temp goes with a higher-odd ID for press: Need to +1 to every temp/even ID
Teleosts: a lower-odd ID for temp goes with a higher-even ID for press: Need to +1 to every temp/odd ID

# Need to filter this out then...

# Sharks
```{r}
shark_temp_data <- 
  sensor_data %>%
  filter(Org_type == "Elasmobranch") %>% 
  filter(ID %% 2 != 1)  %>% 
  #dplyr::select(transmitter_id) %>% 
  mutate(ID = ID+1) %>% 
  mutate(transmitter_id = factor(paste(Freq, Space, ID, sep = '-')))

shark_press_data <- 
  sensor_data %>%
  filter(Org_type == "Elasmobranch") %>% 
  filter(Type =="press") 

```

# Teleosts
```{r}
teleost_temp_data <- 
  sensor_data %>%
  filter(Org_type == "Teleost") %>% 
  filter(ID %% 2 == 1)  %>% 
  #dplyr::select(transmitter_id) %>% 
  mutate(ID = ID+1) %>% 
  mutate(transmitter_id = factor(paste(Freq, Space, ID, sep = '-')))

teleost_press_data <- 
  sensor_data %>%
  filter(Org_type == "Teleost") %>% 
  filter(Type =="press") 

```


## Now that temp and pressure data are split out we can calculate calibrated values for the raw data - see wrangling_sensordata.Rmd
For now let's save these four dataframes
```{r}
save(shark_temp_data, file = "../data/Rdata/shark_temp_data.Rdata")
save(shark_press_data, file = "../data/Rdata/shark_press_data.Rdata")
save(teleost_temp_data, file = "../data/Rdata/teleost_temp_data.Rdata")
save(teleost_press_data, file = "../data/Rdata/teleost_press_data.Rdata")
```





