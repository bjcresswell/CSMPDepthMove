---
title: "Calibrating sensor data"
aauthor: "Ben Cresswell"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
 html_document:
    code_folding: show
    collapse: no
    df_print: paged
    fig_caption: yes
    fig_height: 4
    fig_width: 4
    highlight: textmate
    theme: spacelab
    toc: yes
    toc_float: yes
editor_options: 
  chunk_output_type: inline
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load required packages
```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
library(magrittr)
library(tidyverse)
```

# Housekeeping
```{r warning=FALSE}
rm(list=ls()) # Clear out environment if necessary
```

We start with the four separate files for teleosts and sharks, temperature and pressure as there are difference calibration values for each:


# Load data

```{r}
load("../data/Rdata/osp_sens_data.Rdata")
#head(osp_sens_data)
```

## Assign just one transmitter id to each sensor tag

Currently each animal has 2 x transmitter IDs for their tag - one for temp and one for pressure. If we want to to look at individual animal patterns we'll need to combine these. First will need to check which transmitter IDs go together:
```{r}
osp_sens_data %>% 
  dplyr:: select(transmitter_id, Serial, Org_type, Type) %>% 
  distinct() %>% 
  arrange(Serial)
```

Sharks: a lower-even ID for temp goes with a higher-odd ID for press: Need to +1 to every temp/even ID
Teleosts: a lower-odd ID for temp goes with a higher-even ID for press: Need to +1 to every temp/odd ID

We'll do this and at the same time will calibrate using the calibration coefficients (slope and intercept) for the tags as provided by Vemco.

# Sharks
Calibration coefficients:

    Slope	    Intercept
P   0.9097	  -3.6388
T   0.1575	  -5.157

# Calculate temp
```{r}
shark_temp_data <- 
  osp_sens_data %>%
  filter(Org_type == "Elasmobranch") %>% 
  filter(ID %% 2 != 1)  %>% 
  #dplyr::select(transmitter_id) %>% 
  mutate(ID = ID+1) %>% 
  mutate(transmitter_id = factor(paste(Freq, Space, ID, sep = '-'))) %>% 
  mutate(Temp = `Sensor Value`*0.1575 - 5.157)
```

# Calculate depth 
```{r}
shark_press_data <- 
  osp_sens_data %>%
  filter(Org_type == "Elasmobranch") %>% 
  filter(Type =="press") %>% 
  mutate(Depth = `Sensor Value`*0.9097 - 3.6388)
```

# Combine together so that temp and depth in the same dataframes
```{r}
shark_tp_data <- 
  shark_temp_data %>% 
  full_join(shark_press_data) %>% 
  dplyr::select(transmitter_id, detection_timestamp, station_name, station_name_long, Scientific_name, Date, 
         Location, Site, Sex, FL, TL, Lat, Long, Temp, Depth) %>% 
  filter(!grepl("Lagoon", station_name_long),
         station_name_long != "Overnight_Mooring") %>%  # just a few shark detections (2 individs 14041 and 14059) from lagoon1 so filtering out
  filter(detection_timestamp < as.Date("2022-11-01 00:00:01")) %>% 
  arrange(detection_timestamp) %>% 
  droplevels()
```


# Checks
```{r}
glimpse(shark_tp_data) # No. of observations ~ 789,576
shark_tp_data %$% summary(transmitter_id) # No. of individuals detected - all 15 sharks show up at some point & have 1000's of obs for each
#shark_tp_data  %>% distinct(transmitter_id) # No. of individuals detected - all 15 sharks show up at some point
```
# Save
```{r}
save(shark_tp_data, file = "../data/Rdata/shark_tp_data.Rdata")
```


# Teleosts
Calibration coefficients:

     Slope	    Intercept
P    0.6065	  -2.4258Ã¸
T    0.1575	  -5.157

# Calculate temp
```{r}
teleost_temp_data <- 
  osp_sens_data %>%
  filter(Org_type == "Teleost") %>% 
  filter(ID %% 2 == 1)  %>% 
  #dplyr::select(transmitter_id) %>% 
  mutate(ID = ID+1) %>% 
  mutate(transmitter_id = factor(paste(Freq, Space, ID, sep = '-'))) %>% 
  mutate(Temp = `Sensor Value`*0.1575 - 5.157)
```

# Calculate depth
```{r}
teleost_press_data <- 
  osp_sens_data %>%
  filter(Org_type == "Teleost") %>% 
  filter(Type =="press") %>% 
  mutate(Depth = `Sensor Value`*0.6065 - 2.4258)
```

# Combine together so that temp and depth in the same dataframes
```{r}
teleost_tp_data <- 
  teleost_temp_data %>% 
  full_join(teleost_press_data) %>% 
  select(transmitter_id, detection_timestamp, station_name, station_name_long, Scientific_name, Date, 
         Location, Site, Sex, FL, TL, Lat, Long, Temp, Depth) %>% 
  arrange(detection_timestamp) %>%   
  droplevels()
```

# Checks
```{r}
glimpse(teleost_tp_data) # No. of observations ~ 41,000
teleost_tp_data %$% summary(transmitter_id) # No. of individuals detected - only 8 individuals. Already established we are missing 2 GTs
```

```{r}
save(teleost_tp_data, file = "../data/Rdata/teleost_tp_data.Rdata")
```




