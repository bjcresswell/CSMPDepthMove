---
title: "Shark temperature and depth - model building"
author: "Ben Cresswell"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
 html_document:
    code_folding: show
    collapse: no
    df_print: paged
    fig_caption: yes
    fig_height: 6
    fig_width: 10
    highlight: textmate
    theme: spacelab
    toc: yes
    toc_float: yes
editor_options: 
  chunk_output_type: inline
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	include = FALSE,
	message = FALSE,
	warning = FALSE)
```


```{r include=FALSE}
#rm(list=ls()) # Clear out environment if necessary
source("code/packages.R")
```


```{r}
# Load data
load(file = "data/Rdata/shark_individual_daily_td.Rdata")
```


## Introduction

From basic data exploration steps, it looks like daily maximum depth is the response variable of most interest as a response to changes in SST over time. This document explores the relationship between maximum daily depth and SSTs and also build generalised mixed effect models (GLMMs) to tease apart the effects of other variables of interest.


```{r}
## Check distributions so we know how to model
## Max depth
shark_individual_daily_td %>% ggplot() + geom_histogram(aes(x = daily_max_depth))
## Mean depth
shark_individual_daily_td %>% ggplot() + geom_histogram(aes(x = daily_mean_depth))
## Min depth
shark_individual_daily_td %>% ggplot() + geom_histogram(aes(x = daily_max_depth))
```




# Fit models


## Max depth ~ SST
```{r}
#sst_maxd_glmm1 <- glmmTMB(daily_max_depth ~ SST + (1|transmitter_id), data = shark_individual_daily_td, family = tweedie(), REML = FALSE) # Too simple (only random slope)
#sst_maxd_glmm1a <- glmmTMB(daily_max_depth ~ SST + (SST|transmitter_id), data = shark_individual_daily_td, family = tweedie(), REML = FALSE) # Too simple? Gets at the SST story though
#sst_maxd_glmm2 <- glmmTMB(daily_max_depth ~ Season + (Season|transmitter_id), data = shark_individual_daily_td, family = tweedie(), REML = FALSE) # Too simple - def needs SST in there
#sst_maxd_glmm2a <- glmmTMB(daily_max_depth ~ SST + Season + (SST|transmitter_id), data = shark_individual_daily_td, family = tweedie(), REML = FALSE) # Too simple - need SST * season
sst_maxd_glmm3 <- glmmTMB(daily_movement ~ SST * Season + (SST|transmitter_id), data = shark_individual_daily_td, family = tweedie(), REML = FALSE)
sst_maxd_glmm4 <- glmmTMB(daily_movement ~ SST * Season + Sex + (SST|transmitter_id), data = shark_individual_daily_td, family = tweedie(), REML = FALSE)
sst_maxd_glmm5 <- glmmTMB(daily_movement ~ SST * Season + Sex * TL + (SST|transmitter_id), data = shark_individual_daily_td, family = tweedie(), REML = FALSE)
sst_maxd_glmm5a <- glmmTMB(daily_movement ~ SST * Sex * TL + (SST|transmitter_id), data = shark_individual_daily_td, family = tweedie(), REML = FALSE)
#sst_maxd_glmm6 <- glmmTMB(daily_max_depth ~ Sex * TL + (1|transmitter_id), data = shark_individual_daily_td, family = tweedie(), REML = FALSE)

```

## Residual diagnostics
```{r}
#sst_maxd_glmm1 %>% simulateResiduals(plot=TRUE)
#sst_maxd_glmm1a %>% simulateResiduals(plot=TRUE)
#sst_maxd_glmm2 %>% simulateResiduals(plot=TRUE)
#sst_maxd_glmm2a %>% simulateResiduals(plot=TRUE)
sst_maxd_glmm3 %>% simulateResiduals(plot=TRUE)
sst_maxd_glmm4 %>% simulateResiduals(plot=TRUE)
sst_maxd_glmm5 %>% simulateResiduals(plot=TRUE)
sst_maxd_glmm5a %>% simulateResiduals(plot=TRUE)
```
## Check AIC scores
Using second-order AICc as our sample size is low relative to model parameter number (15:5)
```{r}
AICc(#sst_maxd_glmm1, 
     #sst_maxd_glmm1a, 
     #sst_maxd_glmm2, 
     #sst_maxd_glmm2a, 
     sst_maxd_glmm3, 
     sst_maxd_glmm4, 
     sst_maxd_glmm5, 
     sst_maxd_glmm5a)
```
Model 5 lowest AIC

## R2
```{r}
#sst_maxd_glmm1 %>% performance::r2_nakagawa()
#sst_maxd_glmm1a %>% performance::r2_nakagawa()
#sst_maxd_glmm2 %>% performance::r2_nakagawa()
#sst_maxd_glmm2a %>% performance::r2_nakagawa()
sst_maxd_glmm3 %>% performance::r2_nakagawa()
sst_maxd_glmm4 %>% performance::r2_nakagawa()
sst_maxd_glmm5 %>% performance::r2_nakagawa()
sst_maxd_glmm5a %>% performance::r2_nakagawa()
#sst_maxd_glmm6 %>% performance::r2_nakagawa()
```
Model 5 best fit with fixed factors explaining 38% of the variance (marginal/pseudo R2) and lowest AIC. Also has all the required terms we are interested in. Will move forward with this model, but first note the random effect (individual - slope and intercept) is also explaining a chunk of the variance - indicates substantial individual level differences. I do have some nervousness about co-modelling SST and Season... Model 5a has Season taken out and SST interacting with the other terms but doesn't have as low an AICc

## Rerun Model 5 with REML = TRUE
```{r}
sst_maxd_final <- update(object = sst_maxd_glmm5, REML = TRUE)
```

```{r}
sst_maxd_glmm5 %>% performance::r2_nakagawa()
sst_maxd_final %>% performance::r2_nakagawa()

```

## Mod investigation
```{r}
# Summary
summary(sst_maxd_final)
# Summary of random effects
sst_maxd_final %>% ranef()

```


# Quick overview plots of effects and interactions:

## Simple fixed effects - Model 5
```{r echo=FALSE}
sst_maxd_final %>% ggemmeans(~ Season) %>% plot
sst_maxd_final %>% ggemmeans(~ SST) %>% plot
sst_maxd_final %>% ggemmeans(~ Sex) %>% plot
sst_maxd_final %>% ggemmeans(~ TL) %>% plot
```
Looks like separately, there are some significant effects here:
- Effect of season: definitely seasonal differences - esp between winter and summer
- Effect of SST: a general increase with depth ~ SST
- Effect of sex: looks like some differences here but non-significant. Bayesian approach would probably allow quantification of this?
- Effect of size: again looks like there might be a pattern (smaller individuals going deeper), but this might be non-significant. Would need to do some planned contrasts to check.


## Interaction terms:

### Season * SST
```{r echo = FALSE, include = TRUE, message = FALSE, warning = FALSE}
sst_maxd_final %>% ggemmeans(~ Season*SST) %>% plot
sst_maxd_final %>% ggemmeans(~ SST*Season) %>% plot
sst_maxd_final %>% ggemmeans(~ Season+Sex) %>% plot

```
Quick interpretation - on average deeper in the summer, shallower in the winter and more variable in spring and autumn.

## Sex and size
```{r echo = FALSE, include = TRUE, message = FALSE, warning = FALSE}
sst_maxd_final %>% ggemmeans(~ Sex*TL) %>% plot
sst_maxd_final %>% ggemmeans(~ TL*Sex) %>% plot
```


### SST and sex 
We know (from the above) that males may remain a little deeper than females, but do they respond differently to SSTs or in the same way?
```{r echo = FALSE, include = TRUE, message = FALSE, warning = FALSE}
sst_maxd_final %>% ggemmeans(~ SST * Sex) %>% plot
sst_maxd_final %>% ggemmeans(~ Sex * SST) %>% plot
```

Looks like higher SSTs drive both males and females deeper.

## Quantify some of these patterns in emmeans

```{r echo = FALSE, include = TRUE, message = FALSE, warning = FALSE}
sst_maxd_final %>% ggemmeans(~ Season*SST) %>% plot
sst_maxd_final %>% emmeans( ~ SST*Season) %>% regrid() %>% pairs() %>% confint()

sst_maxd_final %>% ggemmeans(~ Sex) %>% plot
sst_maxd_final %>% emmeans( ~ Sex) %>% regrid() %>% pairs() %>% confint()
```
At the mean SST there are significant differences in all season pairwise contrasts except Autumn - Spring
However, note the warning about interactions:


```{r echo = FALSE, include = TRUE, message = FALSE, warning = FALSE}
sst_maxd_final %>% ggemmeans(~ SST * Sex) %>% plot
sst_maxd_final %>% ggemmeans(~ SST * TL) %>% plot
sst_maxd_final %>% ggemmeans(~ TL * SST) %>% plot
sst_maxd_final %>% ggemmeans(~ TL * Sex) %>% plot

```


```{r echo = FALSE, include = TRUE, message = FALSE, warning = FALSE}
sst_maxd_final %>% emmeans(~ SST)# %>% regrid()
sst_maxd_final %>% emtrends("Sex", var = "SST")# %>% regrid()# %>% contrast()
```


```{r}
sst_maxd_final %>% tidy(conf.int = TRUE)
```

Reminder of model structure:

SST * Season + Sex * TL 


```{r}
Sex_TL_grid <- shark_individual_daily_td %>% 
    with(list(#Sex = levels(Sex),
              TL = seq_range(TL, n = 100)))

  
newdata_Sex_TL <- sst_maxd_final %>% 
  emmeans(~TL, at = Sex_TL_grid) %>% 
  regrid() %>% 
  as_tibble()

#(mod_plot <- 
  ggplot(newdata_Sex_TL, aes(x = TL, y = response)) +
                             #colour = Sex, fill = Sex)) +
  geom_ribbon(aes(ymin=asymp.LCL, ymax=asymp.UCL), color=NA, alpha=0.3) +
  geom_line() +
  geom_point(data=shark_individual_daily_td,  aes(y=daily_movement, x = TL), alpha = 0.4, pch = 21) +
  theme_minimal() +
 # theme(plot.background = element_rect(fill = "transparent", colour = "black", linewidth = 1)) +
  ylab("Daily maximum depth (m)") + 
  xlab("\nTotal length (cm)")
  #)


```








