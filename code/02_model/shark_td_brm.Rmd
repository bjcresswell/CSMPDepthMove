---
title: "Modelling - shark temperature and depth"
author: "Ben Cresswell"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
 html_document:
    code_folding: show
    collapse: no
    df_print: paged
    fig_caption: yes
    fig_height: 4
    fig_width: 4
    highlight: textmate
    theme: spacelab
    toc: yes
    toc_float: yes
editor_options: 
  chunk_output_type: inline
---


```{r include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("packages.R")
#rm(list=ls()) # Clear out environment if necessary
```



```{r echo=FALSE, message=FALSE}
source(knitr::purl("../code/eda_shark_depth.Rmd", quiet=TRUE))
source(knitr::purl("../code/eda_shark_temp.Rmd", quiet=TRUE))
source("individ_daily_td.R")
```


```{r}
shark_1_td %>% 
  filter(is.na(daily_max_depth))
```


We used glmmTMB to explore some of the main effects, both fixed and random, and their interactions.

Now will remodel in a Bayesian framework.

Model 5 and 5a were the most appropriate for our purposes (TBC) but take ages to run in brms, so will trial with simple model first (to get priors sorted etc)


# Model fitting

Model formula will be:
```{r}
td.form <- bf(daily_max_depth ~ SST + (SST|transmitter_id), family = "gaussian")
```

We can see what priors we need to specify for such a model and what the default priors would be if we don't specify
```{r}
get_prior(daily_max_depth ~ SST + (SST|transmitter_id), data = shark_1_td, family = "gaussian")
```


I would quite like to see what these priors look like:
```{r}
standist::visualize("student_t(3, 49.1, 36.4)",
                    "student_t(3, 0, 36.4)"
                    #"normal(0, 1)",
                    #"gamma(5,0.1)",
                    #"gamma(5,1)",
                    #"cauchy(0,5)"
                    )
```


```{r}
priors <- 
  prior(normal(35,5), class = 'Intercept') +
  prior(normal(0, 10), class = 'b')
  #prior(gamma(2,0.5), class = 'sigma') +
  #prior(normal(0,5), class = 'sd') 

priors2 <- 
  prior(student_t(3, 49.1, 36.4), class = 'Intercept') +
  prior(normal(0, 10), class = 'b') +
  prior(gamma(2,0.5), class = 'sigma') +
  prior(normal(0,5), class = 'sd') 
  
```



# Prior only model

```{r message=FALSE}
prior_mod <- brm(td.form, 
                  data = shark_1_td,
                  prior = priors2,
                  sample_prior = 'only',
                  iter = 5000,
                  warmup = 2500,
                  chains = 3,
                  thin = 5)
```

## Chain diagnostics
```{r}
plot(prior_mod)
```


```{r}
prior_mod %>% conditional_effects() %>%  plot(points = TRUE)
```

## Fit model with data

```{r message=FALSE, warning=FALSE}
td_mod <- brm(td.form, 
              data = shark_1_td,
              prior = priors2,
              sample_prior = 'yes',
              iter = 5000,
              warmup = 2500,
              chains = 3,
              cores = 3,
              thin = 5,
              refresh = 0,
              backend = "cmdstanr")

td_mod2 <- brm(td.form, 
              data = shark_1_td,
              prior = priors,
              sample_prior = 'yes',
              iter = 2000,
              warmup = 1000,
              chains = 3,
              cores = 3,
              thin = 5,
              refresh = 0,
              backend = "cmdstanr")
```


## Chain diagnostics - main model
```{r}
plot(td_mod)
```
## Chain diagnostics - detail
```{r}
mcmc_plot(td_mod,  type='trace')
mcmc_plot(td_mod,  type='acf_bar')
mcmc_plot(td_mod,  type='rhat_hist')
mcmc_plot(td_mod,  type='neff_hist')
```




```{r}
td_mod %>% conditional_effects() %>%  plot(points = TRUE)
```



```{r}
td_mod %>% get_variables()
```



```{r}
td_mod %>% hypothesis("SST=25")
td_mod %>% hypothesis("SST=30")
td_mod2 %>% hypothesis("SST=+25") %>% plot()
```



```{r}
td_mod %>% ggpredict() 
td_mod2 %>% ggpredict() 
```


## Model exploration

```{r}
td_mod %>% ggemmeans(~ SST) %>% plot 
```






```{r}



```








